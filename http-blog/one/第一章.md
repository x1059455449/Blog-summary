**本博客摘自图解HTTP以及饥人谷相关课件，转载请务必注明来源，另外请支持正版书籍，侵权请联系作者删除，再次感谢**

# TCP/IP 的分层管理 #

TCP/IP 协议族里重要的一点就是分层。TCP/IP 协议族按层次分别分为以下 4 层：应用层、传输层、网络层和数据链路层。把 TCP/IP 层次化是有好处的。比如，如果互联网只由一个协议统筹，某个地方需要改变设计时，就必须把所有部分整体替换掉。而分层之后只需把变动的层替换掉即可。把各层之间的接口部分规划好之后，每个层次内部的设计就能够自由改动了。值得一提的是，层次化之后，设计也变得相对单了。处于应用层上的应用可以只考虑分派给自己的任务，而不需要弄清对方在地球上哪个地方、对方的传输路线是怎样的、是否能确保传输送达等问题。

# OSI模型 #

## 应用层

应用层（Application Layer）提供为应用软件而设的接口，以设置与另一应用软件之间的通信。例如: HTTP，HTTPS，FTP，TELNET，SSH，SMTP，POP3等。应用层决定了向用户提供应用服务时通信的活动。TCP/IP 协议族内预存了各类通用的应用服务。比如，FTP（FileTransfer Protocol，文件传输协议）和 DNS（Domain Name System，域名系统）服务就是其中两类。HTTP 协议也处于该层。

## 表示层

表达层（Presentation Layer）把数据转换为能与接收者的系统格式兼容并适合传输的格式。

## 会话层

会话层（Session Layer）负责在数据传输中设置和维护计算机网络中两台计算机之间的通信连接。

## 传输层

传输层（Transport Layer）把传输表头（TH）加至数据以形成数据包。传输表头包含了所使用的协议等发送信息。例如:TCP、UDP等。传输层对上层应用层，提供处于网络连接中的两台计算机之间的数据传输。在传输层有两个性质不同的协议：TCP（Transmission ControlProtocol，传输控制协议）和 UDP（User Data Protocol，用户数据报协议）。

## 网络层

网络层（Network Layer）决定数据的路径选择和转寄，将网络表头（NH）加至数据包，以形成分组。网络表头包含了网络数据。例如:互联网协议（IP）等。网络层用来处理在网络上流动的数据包。数据包是网络传输的最小数据单位。该层规定了通过怎样的路径（所谓的传输路线）到达对方计算机，并把数据包传送给对方。

## 数据链路层

数据链路层（Data Link Layer）负责网络寻址、错误侦测和改错。当表头和表尾被加至数据包时，会形成帧。数据链表头（DLH）是包含了物理地址和错误侦测及改错的方法。数据链表尾（DLT）是一串指示数据包末端的字符串。例如以太网、无线局域网（Wi-Fi）和通用分组无线服务（GPRS）等。

## 物理层

物理层（Physical Layer）在局部局域网上传送数据帧（data frame），它负责管理计算机通信设备和网络媒体之间的互通。包括了针脚、电压、线缆规范、集线器、中继器、网卡、主机适配器等。。硬件上的范畴均在链路层的作用范围之内。

# TCP/IP 通信传输流 #

![OSI](https://blog-http.oss-cn-hangzhou.aliyuncs.com/blog-http-https/OSI.jpg?Expires=1563699529&OSSAccessKeyId=TMP.hWEGBfpNKE1sCb1AGEednT6eu9sNj5juyarRcYuvdkkrsf6jbBhqAEwG59sjAPisxTsGNZU45R9HpcG3dGVHPFhdQSBXA1PoZdwCKAzdt4jU68YUcTPzKCCQinctPp.tmp&Signature=8sWyZxBD%2BcH%2FwJn0EhCQFaWuRvY%3D)

利用 TCP/IP 进行网络通信时，会通过分层顺序与对方进行通信。发送端从应用层往下走，而接收端则往应用层往上走。

以 HTTP 举例来说明，客户端在应用层（HTTP 协议）发出服务器发出一个 Web 页面的 HTTP 请求。基于方便传输，**在传输层（TCP 协议）把从应用层处收到的数据（HTTP 请求报文）进行分割，并在各个报文上打上标记序号及端口号后转发给网络层。**

在网络层（IP 协议），增加作为通信目的地的 MAC 地址后转发给链路层。这样，发往网络的通信请求就准备齐全了。

接收端的服务器在链路层接收到数据，按序往上层发送，一直到应用层。当传输到应用层，才能算真正接收到由客户端发送过来的 HTTP请求。

> 封装

客户端在不同的层与层之间进行传输数据时，**每经过一层时必定会被打上一个该层所属的首部信息。反之，接收端在层与层传输数据时，每经过一层时会把对应的首部消去。**而在这个过程中所涉及到的把数据信息包装起来的方法称之为**封装**。如图所示：

[P19]

# 与 HTTP 关系密切的协议 : IP、TCP 和 DNS #

> 负责传输的 IP 协议

* 按层次分，IP网际协议位于网络层
* IP协议的作用：各种数据包传送给对方。要保证确实传送到对方那里，则需要满足各类条件。其中两个重要的条件是 IP 地址和 MAC地址（Media Access Control Address）。IP 地址指明了节被分配到的地址，MAC 地址是指网卡所属的固定地址。IP 地址可以和 MAC 地址进行配对。IP 地址可变换，但 MAC地址基本上不会更改。ARP 协议以 MAC 地址进行通信。
* IP 间的通信依赖 MAC 地址。在网络上，通信的双方在同一局域网（LAN）内的情况是很少的，通常是经过多台计算机和网络设备中转才能连接到对方。而在进行中转时，会利用下一站中转设备的 MAC地址来搜索下一个中转目标。这时，会采用 ARP 协议（AddressResolution Protocol）。
* 这种机制称之为路由选择。

**ARP 是一种用以解析地址的协议，根据通信方的 IP 地址就可以反查出对应的 MAC 地址。通过解析网络层地址来找寻数据链路层地址的网络传输协议**

[wiki地址解析协议](https://zh.wikipedia.org/wiki/%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE)

> 确保可靠性的 TCP 协议

* 按层次分，TCP 位于传输层，提供可靠的字节流服务。TCP 协议为了更容易传送大数据才把数据分割，而且 TCP 协议能够确认数据最终是否送达到对方。
* 如何分割：通过字节流服务（Byte Stream Service），了方便传输，将大块数据分割成以报文段（segment）为单位的数据包进行管理。
* 如何确保数据能到达目标（三次握手）

## TCP三次握手 ##

[P22]

握手过程中使用了 TCP 的标志（flag） —— SYN（synchronize） 和AC（acknowledgement）。
发送端首先发送一个带 SYN 标志的数据包给对方。接收端收到后，回传一个带有 SYN/ACK 标志的数据包以示传达确认信息。最后，发送端再回传一个带 ACK 标志的数据包，代表“握手”结束。

## TCP/IP四层模型 ##

**应用层**

	应用层是大多数普通与网络相关的程序为了通过网络与其他程序通信所使用的层。这个层的处理

	过程是应用特有的；数据从网络相关的程序以这种应用内部使用的格式进行传送，然后被编码

	成标准协议的格式。每一个应用层协议一般都会使用到传输层协议TCP和UDP协议之一：

运行在TCP协议上的协议：

	HTTP（80端口），主要用于普通浏览。
	HTTPS（443端口）,HTTP协议的安全版本。
	FTP（20和21端口），由名知义，用于文件传输。
	POP3（110端口），收邮件用。
	SMTP（25端口），用来发送电子邮件。
	SSH（22端口），用于加密安全登陆用。

运行在UDP协议上的协议：

	DHCP（67端口，动态主机配置协议），动态配置IP地址。

其他：

	DNS（Domain Name Service，域名服务），用于完成地址查找，邮件转发等工作（运行在TCP和UDP协议上）。
	
	SNMP（Simple Network Management Protocol，简单网络管理协议），用于网络信息的收集和网络管理。
	
	ARP（Address Resolution Protocol，地址解析协议），用于动态解析以太网硬件的地址。

**传输层**

解决诸如端到端可靠性（数据是否已经到达目的地？）和保证数据按照正确的顺序到达这样的问题。TCP、UDP都是传输层协议。

**网络层**

解决在一个单一网络上传输数据包的问题。IP协议是网络层协议。

**数据链路层**

它是数据包从一个设备的网络层传输到另外一个设备的网络层的方法。这个过程能够在网卡的软件驱动程序中控制或者专用芯片中控制。这将完成如添加报头准备发送、通过实体介质实际发送这样一些数据链路功能。另一端，链路层将完成数据帧接收、去除报头并且将接收到的包传到网络层。

[TCP/IP四层模型](https://www.cnblogs.com/BlueTzar/articles/811160.html)
[TCP/IP（八）之总结TCP/IP四层模型](https://cloud.tencent.com/developer/article/1023759)

> 负责域名解析的 DNS 服务

DNS（Domain Name System）服务是和 HTTP 协议一样位于应用层的协议。它提供域名到 IP 地址之间的解析服务。DNS 协议提供通过域名查找 IP 地址，或逆向从 IP 地址反查域名的服务。

## 关系总结 ##

[P24]

## URI(统一资源标识符) 和 URL(统一资源定位符) ##

URI 用字符串标识某一互联网资源，而 URL表示资源的地点（互联网上所处的位置）。 URL是 URI 的子集。其实，在某种特定的情况下，URI和URL可以理解成是一样的。

> URI 格式
[P27]

# TCP三步握手和四步挥手（加图） #

> 关于TCP协议

TCP（Transmission Control Protocol， 传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议。与之对应的是UDP（User Datagram Protocol ，用户数据报协议），是不可靠的传输层协议。

> 三步握手

客户端发送 SYN报文给服务器端，序列号是n，进入 SYN_SEND 状态。
服务器端收到 SYN 报文，回应一个ACK（序列号是n+1）同时发一个 SYN （序列号是m），进入 SYN_RECV 状态。
客户端收到服务器端的 SYN 报文，回应一个 ACK(序列号是m+1）报文，进入 Established 状态。

> 四次挥手

客户端发送一个 FIN ，告诉服务器想关闭连接。
服务器收到这个 FIN ，发回一个 ACK。
服务器通知应用程序关闭网络连接，应用程序关闭后通知服务器。服务器发送一个 FIN 给客户端 。
客户端发回 ACK 报文确认。

**为什么挥手需要4次**

这是因为服务端的 LISTEN 状态下的 SOCKET 当收到客户端建立连接请求的SYN 报文后，它可以把 ACK 和 SYN （ ACK 起应答作用，而 SYN 起同步作用）放在一个报文里来发送。但关闭连接时，当服务器收到客户端的 FIN 报文通知时，服务器只能发一个回应报文ACK：“哦，我知道了”，然后通知应用程序。应用程序完成全部数据发送并确定可以终止了，服务器才能发送FIN告诉客户端可以真正断开连接了。所以这一步ACK报文和FIN报文需要分开发送，因此多了一个步骤。

# 参考 #

[wiki地址解析协议](https://zh.wikipedia.org/wiki/%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE)

[TCP/IP四层模型](https://www.cnblogs.com/BlueTzar/articles/811160.html)

[TCP/IP（八）之总结TCP/IP四层模型](https://cloud.tencent.com/developer/article/1023759)

[wikiTCP](https://zh.wikipedia.org/wiki/%E4%BC%A0%E8%BE%93%E6%8E%A7%E5%88%B6%E5%8D%8F%E8%AE%AE)

[CSDN-TCP报文详解](https://blog.csdn.net/daocaoren1543169565/article/details/80535949)

